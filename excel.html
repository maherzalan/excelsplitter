<!DOCTYPE html>
<html lang="ar">

<head>
  <meta charset="UTF-8">
  <title>ุฅุญุตุงุฆูุงุช ุงูุฅุฌุงุจุงุช - ุฏูุฌ ุงูุชูุงุตูู</title>
  <!-- ุชุถููู ููุชุจุฉ SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- ุชุถููู ููุชุจุฉ Sortable.js ููุณุญุจ ูุงูุฅููุงุช -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      line-height: 1.8;
      background-color: #f0f8ff;
      padding: 20px;
      color: #2c3e50;
      direction: rtl;
    }

    .container {
      background-color: #ffffff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      text-align: right;
    }

    h1,
    h2,
    h3 {
      color: #3498db;
    }

    ul {
      list-style: none;
      padding-right: 20px;
      margin-bottom: 20px;
    }

    ul li {
      padding: 8px;
      border: 1px solid #ddd;
      margin-bottom: 5px;
      background: #f9f9f9;
      cursor: move;
      display: flex;
      align-items: center;
    }

    ul li input[type="checkbox"] {
      margin-left: 10px;
    }

    button {
      padding: 12px 20px;
      font-size: 16px;
      color: white;
      background-color: #3498db;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin: 5px 0;
    }

    button:hover {
      background-color: #2980b9;
    }

    input[type="file"],
    input[type="number"],
    select {
      margin-bottom: 15px;
    }

    #progressContainer {
      width: 100%;
      background-color: #eee;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    #progressBar {
      width: 0%;
      height: 20px;
      background-color: #3498db;
      text-align: center;
      color: white;
      line-height: 20px;
      transition: width 0.3s;
    }

    footer {
      margin-top: 20px;
      font-size: 14px;
      color: #555;
      text-align: center;
    }

    .instructions,
    .mergeOptions,
    .idMergeOptions,
    .detailsMergeOptions {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      background: #fdfdfd;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ุฅุญุตุงุฆูุงุช ุงูุฅุฌุงุจุงุช ููู ุงูุชูุงุตูู</h1>
    <!-- ูุณู ุงููุตู ูุงูุชุนูููุงุช -->
    <div class="instructions">
      <h2>๐ ูุตู ุงูุณูุฑุจุช ูุขููุฉ ุงูุนูู</h2>
      <p>
        ููุงู ุซูุงุซ ุทุฑู ูุฏูุฌ ูููุงุช Excel:
      </p>
      <ul>
        <li>ุงูุฏูุฌ ุงูุนุงุฏู ูุน ุฅุถุงูุฉ ุงุณู ุงูููู ูุงูุงุนูุฏุฉ ุงููุฎุชุงุฑุฉ.</li>
        <li>ุฏูุฌ ุงููููุงุช ุญุณุจ ุฑูู ุงููููุฉ ุจุญูุซ ูุชู ุชูุฒูุน ุงูุฏุฑุฌุงุช ูุฅุถุงูุฉ ุนููุฏ ุงูุญุงูุฉ (ููุชูู/ุบูุฑ ููุชูู).</li>
        <li>ุฏูุฌ ุงูุชูุงุตูู: ุญูุซ ูุญุชูู ุงูููู ุงูุฃุณุงุณู (ุงูุฃูู) ุนูู ุฑูู ุงููููุฉ ูุจุนุถ ุงูุจูุงูุงุช ูุซู ุงูุนูุงูุงุชุ ูุงููููุงุช ุงูุฃุฎุฑู
          ุชุญุชูู ุนูู ุจูุงูุงุช ุฅุถุงููุฉ (ูุงูุงุณูุ ุงูููุทูุฉ ุงูุชุนููููุฉุ ุงููุฏุฑุณุฉุ ุงูุตูุ ุงูุดุนุจุฉุ ุฑูู ุงูุฌูุงูโฆ ุฅูุฎ). ุณูุชู ุฏูุฌ ูุฐู
          ุงููููุงุช ุจุญูุซ ูุธูุฑ ููู ุฑูู ูููุฉ ูุงูุฉ ุงูุชูุงุตูู ูู ุฌููุน ุงููููุงุช.</li>
      </ul>
      <ol>
        <li>ุงุฎุชุฑ ูููุงุช Excel ุจุงุณุชุฎุฏุงู ุฒุฑ "ุงุฎุชูุงุฑ ุงููููุงุช".</li>
        <li>ุญุฏุฏ ุนุฏุฏ ุตููู ุงูููุฏุฑ ุงูุชู ุณูุชู ุชุฌุงูููุง (ูุชุญุฏูุฏ ุตู ุงูุนูุงููู ุงูููุงุณุจ).</li>
        <li>ุนูุฏ ุชุญููู ุงููููุงุชุ ุณูุชู ุงุณุชุฎุฑุงุฌ ุตู ุงูููุฏุฑ ูู ุงูููู ุงูุฃูู ูุชุนุจุฆุฉ ูุงุฆูุฉ ุงูุฃุนูุฏุฉ ููุฐูู ูุงุฆูุฉ ุงุฎุชูุงุฑ ุนููุฏ
          ุงูููุชุงุญ ููุฏูุฌ ุงูุชูุตููู.</li>
        <li>ุงุถุบุท ุงูุฒุฑ ุงูููุงุณุจ ููุฏูุฌ (ุงูุฏูุฌ ุงูุนุงุฏูุ ุฏูุฌ ุญุณุจ ุฑูู ุงููููุฉุ ุฃู ุฏูุฌ ุงูุชูุงุตูู).</li>
      </ol>
    </div>

    <!-- ุฅุนุฏุงุฏุงุช ุนุงูุฉ ููุฏูุฌ -->
    <div class="mergeOptions">
      <label for="headerRows">ุนุฏุฏ ุตููู ุงูููุฏุฑ (ุงูุชู ุณูุชู ุชุฌุงูููุง): </label>
      <input type="number" id="headerRows" value="0" min="0" step="1">
      <br>
      <!-- ูุงุฆูุฉ ุงูุฃุนูุฏุฉ ููุฏูุฌ ุงูุนุงุฏู -->
      <div id="columnSelector" style="display: none;">
        <h3>ุชุญุฏูุฏ ูุชุฑุชูุจ ุงูุฃุนูุฏุฉ (ุงูุณุญุจ ูุชุบููุฑ ุงูุชุฑุชูุจ):</h3>
        <ul id="columnsList"></ul>
      </div>
      <button id="downloadAllFiles">ุฏูุฌ ุงููููุงุช (ุงูุฏูุฌ ุงูุนุงุฏู)</button>
    </div>

    <!-- ุฅุนุฏุงุฏุงุช ุฏูุฌ ุญุณุจ ุฑูู ุงููููุฉ (ููุง ูู ุงูููุฏ ุงูุณุงุจู) -->
    <div class="idMergeOptions" style="display: none;">
      <h3>ุฏูุฌ ุงููููุงุช ุญุณุจ ุฑูู ุงููููุฉ</h3>
      <label for="keyColumnSelect">ุงุฎุชุฑ ุนููุฏ ุฑูู ุงููููุฉ:</label>
      <select id="keyColumnSelect"></select>
      <br>
      <label for="valueColumnSelect">ุงุฎุชุฑ ุนููุฏ ุงูุฏุฑุฌุฉ:</label>
      <select id="valueColumnSelect"></select>
      <br>
      <button id="mergeById">ุฏูุฌ ุงููููุงุช ุญุณุจ ุฑูู ุงููููุฉ</button>
    </div>

    <!-- ุฅุนุฏุงุฏุงุช ุฏูุฌ ุงูุชูุงุตูู -->
    <div class="detailsMergeOptions" style="display: none;">
      <h3>ุฏูุฌ ุงูุชูุงุตูู ุจูุงุกู ุนูู ุฑูู ุงููููุฉ</h3>
      <label for="keyColumnDetails">ุงุฎุชุฑ ุนููุฏ ุฑูู ุงููููุฉ (ูู ุงูููู ุงูุฃุณุงุณู):</label>
      <select id="keyColumnDetails"></select>
      <br>
      <p>
        ุณูุชู ุงุนุชุจุงุฑ ุงูููู ุงูุฃูู ูููู ุฃุณุงุณู ูุญุชูู ุนูู ุจูุงูุงุช (ูุซู ุงูุนูุงูุงุช)ุ ูุชูุถุงู ูู ุจูุงูุงุช ูู ุงููููุงุช ุงูุฃุฎุฑู (ูุซู
        ุงูุงุณู ูุงูููุทูุฉ ุงูุชุนููููุฉ ูุงููุฏุฑุณุฉ โฆ).
      </p>
      <button id="mergeDetails">ุฏูุฌ ุงูุชูุงุตูู</button>
    </div>

    <!-- ูุณู ุชุญููู ุงููููุงุช -->
    <h2>ุชุญููู ุงููููุงุช</h2>
    <input type="file" multiple id="fileInput" accept=".xls,.xlsx">
    <br>
    <!-- ุดุฑูุท ุงูุชูุฏู -->
    <div id="progressContainer">
      <div id="progressBar">0%</div>
    </div>
  </div>

  <footer>
    ุฌููุน ุงูุญููู ูุญููุธุฉ ูุฏู Mr.Maher Zalan | ๐ 0599535638
  </footer>

  <script>
    const fileInput = document.getElementById('fileInput');
    const columnsList = document.getElementById('columnsList');
    const columnSelector = document.getElementById('columnSelector');
    const progressBar = document.getElementById('progressBar');
    const idMergeOptions = document.querySelector('.idMergeOptions');
    const detailsMergeOptions = document.querySelector('.detailsMergeOptions');
    const keyColumnSelect = document.getElementById('keyColumnSelect');
    const valueColumnSelect = document.getElementById('valueColumnSelect');
    const keyColumnDetails = document.getElementById('keyColumnDetails');
    let headerColumns = []; // ุชุฎุฒูู ุฃุณูุงุก ุงูุฃุนูุฏุฉ ูู ุงูููู ุงูุฃูู
    let selectedColumns = []; // ููุฏูุฌ ุงูุนุงุฏู

    // ุนูุฏ ุงุฎุชูุงุฑ ุงููููุงุชุ ูุณุชุฎูุต ุตู ุงูููุฏุฑ ูู ุงูููู ุงูุฃูู ุจูุงุกู ุนูู ุนุฏุฏ ุงูุตููู ุงูููุฏุฎูุฉ
    fileInput.addEventListener('change', function () {
      const files = fileInput.files;
      if (!files.length) return;
      const headerRowsCount = parseInt(document.getElementById('headerRows').value, 10);
      const firstFile = files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = e.target.result;
        const workbook = XLSX.read(data, { type: 'binary' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        let jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
        // ุงุณุชุฎุฏุงู ุงูุตู ุงููุญุฏุฏ ุจูุงุณุทุฉ headerRowsCount ูุตู ููุนูุงููู ุฅู ููุฌุฏุ ูุฅูุง ุงูุตู ุงูุฃูู
        if (headerRowsCount > 0 && jsonData.length > headerRowsCount) {
          headerColumns = jsonData[headerRowsCount];
          jsonData = jsonData.slice(headerRowsCount);
        } else {
          headerColumns = jsonData[0];
        }
        console.log("ุจูุงูุงุช ุงูููุฏุฑ:", headerColumns);
        if (!headerColumns || headerColumns.length === 0) {
          alert("โ๏ธ ุตู ุงูููุฏุฑ ูุงุฑุบ! ูุฑุฌู ุงูุชุฃูุฏ ูู ุงูููู ุฃู ุชุนุฏูู ุนุฏุฏ ุตููู ุงูููุฏุฑ.");
          columnSelector.style.display = 'none';
          idMergeOptions.style.display = 'none';
          detailsMergeOptions.style.display = 'none';
          return;
        }
        // ุจูุงุก ูุงุฆูุฉ ุงูุฃุนูุฏุฉ ููุฏูุฌ ุงูุนุงุฏู
        buildColumnsList(headerColumns);
        columnSelector.style.display = 'block';
        // ุชุนุจุฆุฉ ุฎูุงุฑุงุช ุงูุฏูุฌ ุญุณุจ ุฑูู ุงููููุฉ
        populateSelectOptions(headerColumns);
        idMergeOptions.style.display = 'block';
        // ุชุนุจุฆุฉ ูุงุฆูุฉ ุนููุฏ ุงูููุชุงุญ ููุฏูุฌ ุงูุชูุตููู (ูู ุงูููู ุงูุฃุณุงุณู)
        populateKeyDetailsOptions(headerColumns);
        detailsMergeOptions.style.display = 'block';
      };
      reader.readAsBinaryString(firstFile);
    });

    // ุฏุงูุฉ ูุจูุงุก ูุงุฆูุฉ ุงูุฃุนูุฏุฉ ุจุงุณุชุฎุฏุงู ุนูุงุตุฑ <li> ููุฏูุฌ ุงูุนุงุฏู
    function buildColumnsList(columns) {
      columnsList.innerHTML = '';
      columns.forEach((col, index) => {
        const li = document.createElement('li');
        li.setAttribute('data-index', index);
        li.innerHTML = `<span>${col}</span>
                        <input type="checkbox" checked title="ุชุญุฏูุฏ ุงูุนููุฏ">`;
        columnsList.appendChild(li);
      });
      Sortable.create(columnsList, { animation: 150 });
    }

    // ุชุนุจุฆุฉ ุฎูุงุฑุงุช select ููุฏูุฌ ุญุณุจ ุฑูู ุงููููุฉ
    function populateSelectOptions(columns) {
      keyColumnSelect.innerHTML = '';
      valueColumnSelect.innerHTML = '';
      columns.forEach((col, index) => {
        const optionKey = document.createElement('option');
        optionKey.value = index;
        optionKey.textContent = col;
        keyColumnSelect.appendChild(optionKey);
        const optionValue = document.createElement('option');
        optionValue.value = index;
        optionValue.textContent = col;
        valueColumnSelect.appendChild(optionValue);
      });
    }

    // ุชุนุจุฆุฉ ูุงุฆูุฉ select ูุนููุฏ ุงูููุชุงุญ ููุฏูุฌ ุงูุชูุตููู
    function populateKeyDetailsOptions(columns) {
      keyColumnDetails.innerHTML = '';
      columns.forEach((col, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = col;
        keyColumnDetails.appendChild(option);
      });
    }

    // ุฏุงูุฉ ูุฌูุจ ุชุฑุชูุจ ุงูุฃุนูุฏุฉ ุงููุฎุชุงุฑุฉ ูู ูุงุฆูุฉ <li> ููุฏูุฌ ุงูุนุงุฏู
    function getSelectedColumns() {
      const lis = columnsList.querySelectorAll('li');
      const cols = [];
      lis.forEach(li => {
        const checkbox = li.querySelector('input[type="checkbox"]');
        if (checkbox.checked) {
          const idx = parseInt(li.getAttribute('data-index'), 10);
          cols.push({ index: idx, name: headerColumns[idx] });
        }
      });
      return cols;
    }

    // ุฒุฑ ุงูุฏูุฌ ุงูุนุงุฏู (ูุน ุฅุถุงูุฉ ุงุณู ุงูููู ูู ุงูุนููุฏ ุงูุฃูู)
    document.getElementById('downloadAllFiles').addEventListener('click', function () {
      const files = fileInput.files;
      const headerRowsCount = parseInt(document.getElementById('headerRows').value, 10);
      if (!files.length) {
        alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ูููุงุช Excel');
        return;
      }
      selectedColumns = getSelectedColumns();
      if (!selectedColumns.length) {
        alert("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุนููุฏ ูุงุญุฏ ุนูู ุงูุฃูู ูู ูุงุฆูุฉ ุงูุฃุนูุฏุฉ.");
        return;
      }
      let mergedData = [];
      let processedCount = 0;
      const totalFiles = files.length;
      function updateProgress() {
        const percent = Math.round((processedCount / totalFiles) * 100);
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
      }
      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function (e) {
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: 'binary' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          let jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          if (index === 0) {
            if (headerRowsCount > 0 && jsonData.length > headerRowsCount) {
              jsonData = jsonData.slice(headerRowsCount);
            }
          } else {
            if (headerRowsCount > 0) {
              jsonData = jsonData.slice(headerRowsCount);
            }
          }
          jsonData = jsonData.map((row, rowIndex) => {
            if (index === 0 && rowIndex === 0) {
              return ['ุงุณู ุงูููู', ...row];
            } else {
              return [file.name, ...row];
            }
          });
          if (index === 0) {
            const newHeader = ['ุงุณู ุงูููู'];
            selectedColumns.forEach(col => {
              newHeader.push(col.name);
            });
            jsonData[0] = newHeader;
            jsonData = jsonData.map((row, idx) => {
              if (idx === 0) return row;
              const newRow = [row[0]];
              selectedColumns.forEach(col => {
                newRow.push(row[col.index + 1] || '');
              });
              return newRow;
            });
          } else {
            jsonData = jsonData.map(row => {
              const newRow = [row[0]];
              selectedColumns.forEach(col => {
                newRow.push(row[col.index + 1] || '');
              });
              return newRow;
            });
          }
          mergedData = mergedData.concat(jsonData);
          processedCount++;
          updateProgress();
          if (processedCount === totalFiles) {
            if (mergedData.length === 0) {
              alert("โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ูู ุงููููุงุช ุงููุญุฏุฏุฉ!");
              return;
            }
            const newSheet = XLSX.utils.aoa_to_sheet(mergedData);
            const newWorkbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(newWorkbook, newSheet, 'Merged');
            XLSX.writeFile(newWorkbook, 'merged.xlsx');
          }
        };
        reader.readAsBinaryString(file);
      });
    });

    // ุฒุฑ ุฏูุฌ ุงููููุงุช ุญุณุจ ุฑูู ุงููููุฉ (ูุน ุนููุฏ ุงูุญุงูุฉ)
    document.getElementById('mergeById').addEventListener('click', function () {
      const files = fileInput.files;
      const headerRowsCount = parseInt(document.getElementById('headerRows').value, 10);
      if (!files.length) {
        alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ูููุงุช Excel');
        return;
      }
      const keyColIndex = parseInt(keyColumnSelect.value, 10);
      const valueColIndex = parseInt(valueColumnSelect.value, 10);
      let mergedById = {}; // ูุชุฌููุน ุงูุจูุงูุงุช ุจูุงุกู ุนูู ุงูููุชุงุญ
      let fileNames = []; // ูุชุฎุฒูู ุฃุณูุงุก ุงููููุงุช
      let processedCount = 0;
      const totalFiles = files.length;
      function updateProgress() {
        const percent = Math.round((processedCount / totalFiles) * 100);
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
      }
      Array.from(files).forEach((file, index) => {
        fileNames.push(file.name);
        const reader = new FileReader();
        reader.onload = function (e) {
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: 'binary' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          let jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          if (headerRowsCount > 0 && jsonData.length > headerRowsCount) {
            jsonData = jsonData.slice(headerRowsCount);
          } else {
            jsonData = jsonData.slice(1);
          }
          jsonData.forEach((row) => {
            const key = row[keyColIndex] ? row[keyColIndex].toString().trim() : '';
            const value = row[valueColIndex] || '';
            if (!key) return;
            if (!mergedById[key]) {
              mergedById[key] = { key: key };
            }
            mergedById[key][file.name] = value;
          });
          processedCount++;
          updateProgress();
          if (processedCount === totalFiles) {
            const finalHeader = ['ุฑูู ุงููููุฉ', ...fileNames, "ุงูุญุงูุฉ"];
            const finalData = [finalHeader];
            for (let k in mergedById) {
              const row = [mergedById[k].key];
              let complete = true;
              fileNames.forEach(name => {
                const val = mergedById[k][name] || '';
                row.push(val);
                if (!val || val.toString().trim() === '') {
                  complete = false;
                }
              });
              row.push(complete ? "ููุชูู" : "ุบูุฑ ููุชูู");
              finalData.push(row);
            }
            const newSheet = XLSX.utils.aoa_to_sheet(finalData);
            const newWorkbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(newWorkbook, newSheet, 'MergedByID');
            XLSX.writeFile(newWorkbook, 'merged_by_id.xlsx');
          }
        };
        reader.readAsBinaryString(file);
      });
    });

    // ุฒุฑ ุฏูุฌ ุงูุชูุงุตูู
    document.getElementById('mergeDetails').addEventListener('click', function () {
      const files = fileInput.files;
      const headerRowsCount = parseInt(document.getElementById('headerRows').value, 10);
      if (!files.length) {
        alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ูููุงุช Excel');
        return;
      }
      // ูุนุชูุฏ ุฃู ุงูููู ุงูุฃูู ูู ุงูุฃุณุงุณู
      const keyIndex = parseInt(keyColumnDetails.value, 10);
      let primaryData = {};
      let primaryHeader = [];
      let processedCount = 0;
      const totalFiles = files.length;

      function updateProgress() {
        const percent = Math.round((processedCount / totalFiles) * 100);
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
      }

      // ูุฑุงุกุฉ ุงูููู ุงูุฃุณุงุณู (ุงูุฃูู)
      const readerPrimary = new FileReader();
      readerPrimary.onload = function (e) {
        const data = e.target.result;
        const workbook = XLSX.read(data, { type: 'binary' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        let jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
        if (headerRowsCount > 0 && jsonData.length > headerRowsCount) {
          primaryHeader = jsonData[headerRowsCount];
          jsonData = jsonData.slice(headerRowsCount + 1);
        } else {
          primaryHeader = jsonData[0];
          jsonData = jsonData.slice(1);
        }
        // ุจูุงุก ูุงููุณ ููููู ุงูุฃุณุงุณู ูุน ุงูููุชุงุญ ูุฑูู ุงููููุฉ (ุงูุชุฑุงุถ ุฃู ุงูููุชุงุญ ููุฌูุฏ ูู ุงูุนููุฏ ุงููุญุฏุฏ)
        jsonData.forEach(row => {
          const key = row[keyIndex] ? row[keyIndex].toString().trim() : '';
          if (!key) return;
          primaryData[key] = row;
        });
        processedCount++;
        updateProgress();
        // ุจุนุฏ ูุฑุงุกุฉ ุงูููู ุงูุฃุณุงุณูุ ูุณุชูุฑ ูู ูุฑุงุกุฉ ุงููููุงุช ุงูุฃุฎุฑู ูุฅุถุงูุฉ ุงูุชูุงุตูู
        readSecondaryFiles();
      };
      readerPrimary.readAsBinaryString(files[0]);

      function readSecondaryFiles() {
        // ุฅุฐุง ูุงู ููุงู ููู ูุงุญุฏ ููุทุ ููุชูู ูู ุงูุฏูุฌ
        if (files.length < 2) {
          finalizeMerge();
          return;
        }
        for (let i = 1; i < files.length; i++) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const data = e.target.result;
            const workbook = XLSX.read(data, { type: 'binary' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            let jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
            let secHeader;
            if (headerRowsCount > 0 && jsonData.length > headerRowsCount) {
              secHeader = jsonData[headerRowsCount];
              jsonData = jsonData.slice(headerRowsCount + 1);
            } else {
              secHeader = jsonData[0];
              jsonData = jsonData.slice(1);
            }
            // ููู ุตู ูู ุงูููู ุงูุซุงูููุ ูุจุญุซ ุนู ุฑูู ุงููููุฉ ููุถูู ุจูุงูุงุชู ุฅูู ุงูุณุฌู ุงูุฃุณุงุณู
            jsonData.forEach(row => {
              const key = row[keyIndex] ? row[keyIndex].toString().trim() : '';
              if (!key) return;
              if (primaryData[key]) {
                secHeader.forEach((colName, idx) => {
                  // ุฅุถุงูุฉ ุจูุงูุงุช ุงูููู ุงูุซุงููู ูุน ุงุณู ุงูููู ูุฌุฒุก ูู ุงุณู ุงูุนููุฏ
                  primaryData[key][`${files[i].name} - ${colName}`] = row[idx] || '';
                });
              }
            });
            processedCount++;
            updateProgress();
            if (processedCount === totalFiles) {
              finalizeMerge();
            }
          };
          reader.readAsBinaryString(files[i]);
        }
      }


      function finalizeMerge() {
        // ุฅุนุฏุงุฏ ุตู ุงูููุฏุฑ ุงูููุงุฆู: ูุจุฏุฃ ุจูููู ุงูููู ุงูุฃุณุงุณู ุซู ูุถูู ุงูุฃุนูุฏุฉ ุงูุฌุฏูุฏุฉ ูู ุงููููุงุช ุงูุซุงูููุฉ
        let finalHeader = primaryHeader.slice(); // ุงุณุชุฎุฏุงู ููุฏุฑ ุงูููู ุงูุฃุณุงุณู
        // ุฅุถุงูุฉ ุฃุณูุงุก ุงูุฃุนูุฏุฉ ุงูุฌุฏูุฏุฉ ูู ุงููููุงุช ุงูุซุงูููุฉ
        Object.values(primaryData).forEach(row => {
          Object.keys(row).forEach(colName => {
            if (!finalHeader.includes(colName)) {
              finalHeader.push(colName);
            }
          });
        });
        const finalData = [finalHeader];
        // ุจูุงุก ุงูุตููู ุงูููุงุฆูุฉ ูููุงู ูุชุฑุชูุจ ุงูููุฏุฑ ุงูููุงุฆู
        for (let id in primaryData) {
          const row = primaryData[id];
          const newRow = [];
          finalHeader.forEach(col => {
            newRow.push(row[col] !== undefined ? row[col] : '');
          });
          finalData.push(newRow);
        }
        const newSheet = XLSX.utils.aoa_to_sheet(finalData);
        const newWorkbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWorkbook, newSheet, 'DetailsMerged');
        XLSX.writeFile(newWorkbook, 'details_merged.xlsx');
      }
    });
  </script>
</body>

</html>
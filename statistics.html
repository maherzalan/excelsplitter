<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      line-height: 1.8;
      background-color: #f0f8ff;
      padding: 20px;
      color: #2c3e50;
      direction: rtl;
    }

    .container {
      background-color: #ffffff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      text-align: right;
    }

    h1, h2, h3 {
      color: #3498db;
    }

    .stats-box {
      border: 2px solid #3498db;
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
      background-color: #f8f9fa;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }

    th {
      background-color: #3498db;
      color: white;
    }

    .percentage {
      color: #27ae60;
      font-weight: bold;
    }

    button {
      padding: 12px 20px;
      font-size: 16px;
      color: white;
      background-color: #3498db;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin: 5px 0;
    }

    button:hover {
      background-color: #2980b9;
    }

    .instructions {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      background-color: #fdfdfd;
    }

    footer {
      margin-top: 20px;
      font-size: 14px;
      color: #555;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</h1>
    
    <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª -->
    <div class="instructions">
      <h2>ğŸ“ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</h2>
      <h3>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¹Ù…Ù„:</h3>
      <ol>
        <li>Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Excel" ÙˆØ­Ø¯Ø¯ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</li>
        <li>Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</li>
        <li>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ</li>
        <li>Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ØºÙŠØ± Ø§Ù„Ù…Ù…ØªØ­Ù†ÙŠÙ†</li>
      </ol>

      <h3>Ù…ÙØ§ØªÙŠØ­ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬:</h3>
      <ul>
        <li>Ø§Ù„Ø¹Ø¯Ø¯: ÙŠÙ…Ø«Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† ØªÙ‚Ø¯Ù…ÙˆØ§ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±</li>
        <li>Ø§Ù„Ù†Ø³Ø¨Ø©: Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„ØªØµÙ†ÙŠÙ</li>
        <li>Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ØªÙ…Ø«Ù„ Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</li>
        <li>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: Ø§Ù„ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù„Ù„Ù…Ø¯Ø§Ø±Ø³</li>
        <li>ØºÙŠØ± Ù…Ù…ØªØ­Ù†ÙŠÙ†: Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ÙŠØªÙ‚Ø¯Ù…ÙˆØ§ Ù„Ø£ÙŠ Ø§Ø®ØªØ¨Ø§Ø±</li>
      </ul>
    </div>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="controls">
      <input type="file" id="excelFile" accept=".xlsx, .xls">
      <button onclick="processFile()">Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
    <div id="statsResult"></div>
  </div>
  <footer>
    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¯Ù‰ Mr.Maher Zalan | ğŸ“ 0599535638
  </footer>

  <script>
    let allStats = {};

    function processFile() {
      const file = document.getElementById('excelFile').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        allStats = { 
          stages: {}, 
          regions: {},
          nonTestedStudents: []
        };

        workbook.SheetNames.forEach(sheetName => {
          if (sheetName.toLowerCase() === 'alldata') return;

          const sheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: "" });
          
          const stageStats = {
            totalStudents: jsonData.length,
            subjects: {},
            regionData: {},
            nonTested: 0
          };

          jsonData.forEach(row => {
            const tests = (row["Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªÙŠ ØªÙ‚Ø¯Ù… Ù„Ù‡Ø§"] || "")
              .split(/[,ØŒ]\s*/)
              .map(t => t.trim())
              .filter(t => t);

            // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ØºÙŠØ± Ø§Ù„Ù…Ù…ØªØ­Ù†ÙŠÙ†
            if (tests.length === 0) {
              allStats.nonTestedStudents.push({
                'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©': row['National Id'],
                'Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©': row['Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©'],
                'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©': row['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'],
                'Ø§Ù„ØµÙ': row['Ø§Ù„ØµÙ'],
                'Ø§Ù„Ø´Ø¹Ø¨Ø©': row['Section Name Id'],
                'Ø§Ù„Ø¬Ù†Ø³': row['Gender'],
                'Ø§Ù„Ø¬ÙˆØ§Ù„': row['Mobile']
              });
              stageStats.nonTested++;
            }

            tests.forEach(test => {
              stageStats.subjects[test] = (stageStats.subjects[test] || 0) + 1;
            });

            const region = row["Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©"] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            if (!stageStats.regionData[region]) {
              stageStats.regionData[region] = { total: 0, subjects: {} };
            }
            stageStats.regionData[region].total++;
            
            tests.forEach(test => {
              stageStats.regionData[region].subjects[test] = 
                (stageStats.regionData[region].subjects[test] || 0) + 1;
            });
          });

          allStats.stages[sheetName] = stageStats;

          Object.entries(stageStats.regionData).forEach(([region, data]) => {
            if (!allStats.regions[region]) {
              allStats.regions[region] = { total: 0, subjects: {} };
            }
            allStats.regions[region].total += data.total;
            
            Object.entries(data.subjects).forEach(([test, count]) => {
              allStats.regions[region].subjects[test] = 
                (allStats.regions[region].subjects[test] || 0) + count;
            });
          });
        });

        displayResults(allStats);
      };
      reader.readAsArrayBuffer(file);
    }

    function displayResults(stats) {
      const resultDiv = document.getElementById('statsResult');
      resultDiv.innerHTML = '';

      // Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ ØºÙŠØ± Ø§Ù„Ù…Ù…ØªØ­Ù†ÙŠÙ†
      const nonTestedBox = document.createElement('div');
      nonTestedBox.className = 'stats-box';
      nonTestedBox.innerHTML = `
        <h2>Ø§Ù„Ø·Ù„Ø§Ø¨ ØºÙŠØ± Ø§Ù„Ù…Ù…ØªØ­Ù†ÙŠÙ†</h2>
        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ÙŠØªÙ‚Ø¯Ù…ÙˆØ§ Ù„Ø£ÙŠ Ø§Ø®ØªØ¨Ø§Ø±: ${stats.nonTestedStudents.length}</p>
        <button onclick="downloadNonTested()">ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      `;
      resultDiv.appendChild(nonTestedBox);

      // Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø§Ø­Ù„
      Object.entries(stats.stages).forEach(([stageName, stageData]) => {
        const stageBox = document.createElement('div');
        stageBox.className = 'stats-box';
        
        let content = `
          <h2>Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${stageName}</h2>
          <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨: ${stageData.totalStudents}</p>
          <p>Ø§Ù„Ø·Ù„Ø§Ø¨ ØºÙŠØ± Ø§Ù„Ù…Ù…ØªØ­Ù†ÙŠÙ†: ${stageData.nonTested}</p>
          <table>
            <tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th></tr>
        `;

        Object.entries(stageData.subjects).forEach(([test, count]) => {
          const percentage = ((count / stageData.totalStudents) * 100).toFixed(2);
          content += `
            <tr>
              <td>${test}</td>
              <td>${count}</td>
              <td><span class="percentage">${percentage}%</span></td>
            </tr>
          `;
        });

        content += `</table>`;
        stageBox.innerHTML = content;
        resultDiv.appendChild(stageBox);
      });

      // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ù†Ø§Ø·Ù‚
      const regionBox = document.createElement('div');
      regionBox.className = 'stats-box';
      let regionContent = `<h2>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</h2>`;

      Object.entries(stats.regions).forEach(([region, data]) => {
        regionContent += `
          <h3>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${region}</h3>
          <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨: ${data.total}</p>
          <table>
            <tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th></tr>
        `;

        Object.entries(data.subjects).forEach(([test, count]) => {
          const percentage = ((count / data.total) * 100).toFixed(2);
          regionContent += `
            <tr>
              <td>${test}</td>
              <td>${count}</td>
              <td><span class="percentage">${percentage}%</span></td>
            </tr>
          `;
        });

        regionContent += `</table>`;
      });

      regionBox.innerHTML = regionContent;
      resultDiv.appendChild(regionBox);
    }

    function downloadNonTested() {
      if (allStats.nonTestedStudents.length === 0) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ØºÙŠØ± Ù…Ù…ØªØ­Ù†ÙŠÙ†");
        return;
      }

      const wsData = [
        ['Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©', 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©', 'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©', 'Ø§Ù„ØµÙ', 'Ø§Ù„Ø´Ø¹Ø¨Ø©', 'Ø§Ù„Ø¬Ù†Ø³', 'Ø§Ù„Ø¬ÙˆØ§Ù„']
      ];
      
      allStats.nonTestedStudents.forEach(student => {
        wsData.push([
          student['Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©'],
          student['Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©'],
          student['Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'],
          student['Ø§Ù„ØµÙ'],
          student['Ø§Ù„Ø´Ø¹Ø¨Ø©'],
          student['Ø§Ù„Ø¬Ù†Ø³'],
          student['Ø§Ù„Ø¬ÙˆØ§Ù„']
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "ØºÙŠØ± Ù…Ù…ØªØ­Ù†ÙŠÙ†");
      XLSX.writeFile(wb, "Ø§Ù„Ø·Ù„Ø§Ø¨_ØºÙŠØ±_Ø§Ù„Ù…Ù…ØªØ­Ù†ÙŠÙ†.xlsx");
    }
  </script>
</body>
</html>